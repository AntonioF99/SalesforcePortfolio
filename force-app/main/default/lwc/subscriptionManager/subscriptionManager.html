<template>
  <!-- Spinner -->
  <template if:true={isLoading}>
    <div class="slds-spinner_container">
      <lightning-spinner alternative-text="Loading"></lightning-spinner>
    </div>
  </template>

  <!-- Card Container - MOSTRA SOLO SE CI SONO DATI O STIAMO CREANDO -->
  <template if:true={hasData}>
    <lightning-card title="Subscription" icon-name="standard:contract">
      <!-- View Mode -->
      <template if:true={isViewMode}>
        <div class="slds-p-horizontal_medium">
          <!-- Basic Info -->
          <div class="slds-grid slds-wrap slds-gutters">
            <div class="slds-col slds-size_1-of-2">
              <p><strong>Account:</strong> {accountName}</p>
              <p><strong>Price Plan:</strong> {pricePlanName}</p>
              <p><strong>Quantity:</strong> {subscription.Quantity__c}</p>
            </div>
            <div class="slds-col slds-size_1-of-2">
              <p>
                <strong>Status:</strong>
                <lightning-badge
                  label={subscription.Status__c}
                  variant={statusVariant}
                ></lightning-badge>
              </p>
              <p>
                <strong>Start Date:</strong>
                <lightning-formatted-date-time
                  value={subscription.Start_Date__c}
                ></lightning-formatted-date-time>
              </p>
            </div>
          </div>
        </div>

        <!-- View Mode Actions -->
        <div slot="actions">
          <lightning-button
            label="Edit"
            onclick={handleEdit}
          ></lightning-button>
        </div>
      </template>

      <!-- Edit Mode -->
      <template if:false={isViewMode}>
        <div class="slds-p-horizontal_medium">
          <!-- QUESTO Ãˆ IL FIX CHIAVE: Usa gli eventi del form correttamente -->
          <lightning-record-edit-form
            object-api-name="Subscription__c"
            record-id={recordId}
            onsuccess={handleSuccess}
            onerror={handleError}
            onsubmit={handleSubmit}
          >
            <!-- Account Field -->
            <lightning-input-field field-name="Account__c" required>
            </lightning-input-field>

            <!-- Price Plan Field -->
            <lightning-input-field field-name="Price_Plan__c" required>
            </lightning-input-field>

            <!-- Status Field -->
            <lightning-input-field field-name="Status__c">
            </lightning-input-field>

            <!-- Quantity -->
            <lightning-input-field field-name="Quantity__c">
            </lightning-input-field>

            <!-- Start Date -->
            <lightning-input-field field-name="Start_Date__c">
            </lightning-input-field>

            <!-- End Date -->
            <lightning-input-field field-name="End_Date__c">
            </lightning-input-field>

            <!-- Form Actions DENTRO il form -->
            <div class="slds-m-top_medium">
              <lightning-button
                label="Cancel"
                onclick={handleCancel}
                type="button"
              >
              </lightning-button>
              <lightning-button
                label="Save"
                variant="brand"
                type="submit"
                class="slds-m-left_x-small"
              >
              </lightning-button>
            </div>
          </lightning-record-edit-form>
        </div>
      </template>
    </lightning-card>
  </template>

  <!-- Create Mode - Quando non ci sono dati ma stiamo creando -->
  <template if:false={hasData}>
    <template if:true={isEditing}>
      <lightning-card title="New Subscription" icon-name="standard:contract">
        <div class="slds-p-horizontal_medium">
          <lightning-record-edit-form
            object-api-name="Subscription__c"
            onsuccess={handleSuccess}
            onerror={handleError}
            onsubmit={handleSubmit}
          >
            <!-- Account Field (pre-popolato se abbiamo accountId) -->
            <lightning-input-field
              field-name="Account__c"
              value={accountId}
              required
            >
            </lightning-input-field>

            <!-- Price Plan Field -->
            <lightning-input-field field-name="Price_Plan__c" required>
            </lightning-input-field>

            <!-- Status Field -->
            <lightning-input-field field-name="Status__c">
            </lightning-input-field>

            <!-- Quantity -->
            <lightning-input-field field-name="Quantity__c">
            </lightning-input-field>

            <!-- Start Date -->
            <lightning-input-field field-name="Start_Date__c">
            </lightning-input-field>

            <!-- Form Actions -->
            <div class="slds-m-top_medium">
              <lightning-button
                label="Cancel"
                onclick={handleCancel}
                type="button"
              >
              </lightning-button>
              <lightning-button
                label="Save"
                variant="brand"
                type="submit"
                class="slds-m-left_x-small"
              >
              </lightning-button>
            </div>
          </lightning-record-edit-form>
        </div>
      </lightning-card>
    </template>
  </template>
</template>
